import React, { useState, useRef, useEffect } from 'react';
import { Download, Upload, Palette } from 'lucide-react';

export default function CalendarScheduleMaker() {
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);
  const holidayImageRef = useRef(null);

  const [year, setYear] = useState(2025);
  const [month, setMonth] = useState(12);
  const [fuguoScheduleText, setFuguoScheduleText] = useState('12æœˆ12æ—¥ é€±äº”\n14:00, 16:00\n12æœˆ13æ—¥ é€±å…­\n16:00');
  const [rendeScheduleText, setRendeScheduleText] = useState('12æœˆ22æ—¥ é€±ä¸€\n10:00, 16:00, 18:00\n12æœˆ23æ—¥ é€±äºŒ\n10:00, 12:00, 14:00, 16:00');
  const [notes, setNotes] = useState('');
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [holidayImage, setHolidayImage] = useState(null);
  const [useEmoji, setUseEmoji] = useState(true);
  const [holidayEmoji, setHolidayEmoji] = useState('ğŸŒ´');
  const [customPrimaryColor, setCustomPrimaryColor] = useState('#D4A574');
  const [customSecondaryColor, setCustomSecondaryColor] = useState('#FFFEF7');
  const [customAccentColor, setCustomAccentColor] = useState('#A8B5A0');
  const [textColor, setTextColor] = useState('#000000');
  const [holidayDays, setHolidayDays] = useState([]);

  const softColors = [
    { name: 'å¥¶èŒ¶ç±³', color: '#D4A574' },
    { name: 'è±¡ç‰™ç™½', color: '#FFFEF7' },
    { name: 'é¼ å°¾è‰ç¶ ', color: '#A8B5A0' },
    { name: 'å¯§éœè—', color: '#87CEEB' },
    { name: 'ç«ç‘°ç²‰', color: '#FFB6C1' },
    { name: 'è–°è¡£è‰ç´«', color: '#E6E6FA' },
    { name: 'æ·¡çŠç‘š', color: '#FFB997' },
    { name: 'è–„è·ç¶ ', color: '#98D8C8' },
    { name: 'æ·¡é»ƒ', color: '#FFF8DC' },
    { name: 'æ·¡æ¡ƒ', color: '#FFDAB9' },
    { name: 'å¤©ç©ºè—', color: '#B0E0E6' },
    { name: 'æ·¡ç´«', color: '#DDA0DD' },
    { name: 'ç±³ç™½', color: '#F5F5DC' },
    { name: 'æ·¡ç¶ ', color: '#C1E1C1' },
    { name: 'æè‰²', color: '#FAEBD7' },
    { name: 'æ·ºç°', color: '#D3D3D3' }
  ];

  const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];

  const parseSchedule = (text) => {
    const lines = text.split('\n').filter(line => line.trim());
    const schedule = {};
    let currentDate = null;

    lines.forEach(line => {
      line = line.trim();
      const dateMatch = line.match(/(\d+)æœˆ(\d+)æ—¥/);
      
      if (dateMatch) {
        const day = parseInt(dateMatch[2]);
        currentDate = day;
        schedule[day] = { times: [] };
      } else if (currentDate && line.match(/\d+:\d+/)) {
        const times = line.split(/[,,]/).map(t => t.trim()).filter(t => t);
        schedule[currentDate].times.push(...times);
      }
    });

    return schedule;
  };

  const getDaysInMonth = (year, month) => {
    return new Date(year, month, 0).getDate();
  };

  const getFirstDayOfMonth = (year, month) => {
    return new Date(year, month - 1, 1).getDay();
  };

  const toggleDay = (day) => {
    setHolidayDays(prev => 
      prev.includes(day) ? prev.filter(d => d !== day) : [...prev, day]
    );
  };

  const drawCalendar = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    ctx.fillStyle = customAccentColor;
    ctx.fillRect(0, 0, width, height);

    if (backgroundImage) {
      ctx.globalAlpha = 0.3;
      ctx.drawImage(backgroundImage, 0, 0, width, height);
      ctx.globalAlpha = 1;
    }

    ctx.fillStyle = customPrimaryColor;
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${monthNames[month - 1]} ${year}`, width / 2, 70);

    const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const calendarTop = 120;
    const calendarHeight = height - calendarTop - 180;
    const cellWidth = width / 7;
    const headerHeight = 50;

    ctx.fillStyle = customPrimaryColor;
    ctx.fillRect(0, calendarTop, width, headerHeight);

    ctx.fillStyle = customAccentColor;
    ctx.font = 'bold 24px Arial';
    weekDays.forEach((day, i) => {
      ctx.fillText(day, (i + 0.5) * cellWidth, calendarTop + 35);
    });

    const daysInMonth = getDaysInMonth(year, month);
    const firstDay = getFirstDayOfMonth(year, month);
    const fuguoSchedule = parseSchedule(fuguoScheduleText);
    const rendeSchedule = parseSchedule(rendeScheduleText);

    const rows = Math.ceil((daysInMonth + firstDay) / 7);
    const cellHeight = calendarHeight / rows;

    for (let day = 1; day <= daysInMonth; day++) {
      const position = day + firstDay - 1;
      const row = Math.floor(position / 7);
      const col = position % 7;
      
      const x = col * cellWidth;
      const y = calendarTop + headerHeight + row * cellHeight;

      ctx.strokeStyle = customSecondaryColor;
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, cellWidth, cellHeight);

      if (col === 0 || col === 6) {
        ctx.fillStyle = customSecondaryColor + '40';
        ctx.fillRect(x, y, cellWidth, cellHeight);
      }

      ctx.fillStyle = textColor;
      ctx.font = 'bold 28px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(day, x + cellWidth / 2, y + 35);

      const hasFuguo = fuguoSchedule[day];
      const hasRende = rendeSchedule[day];

      if (hasFuguo) {
        ctx.fillStyle = '#000000';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'right';
        ctx.fillText('å¾©', x + cellWidth - 10, y + 30);
      }

      if (hasRende) {
        ctx.fillStyle = '#000000';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'right';
        const offset = hasFuguo ? 30 : 10;
        ctx.fillText('ä»', x + cellWidth - offset, y + 30);
      }

      if (holidayDays.includes(day)) {
        if (useEmoji) {
          ctx.font = '48px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(holidayEmoji, x + cellWidth / 2, y + cellHeight / 2 + 20);
        } else if (holidayImage) {
          const imgSize = Math.min(cellWidth, cellHeight) * 0.4;
          ctx.drawImage(
            holidayImage,
            x + (cellWidth - imgSize) / 2,
            y + cellHeight / 2 - imgSize / 2,
            imgSize,
            imgSize
          );
        }
      } else {
        const times = [];
        if (hasFuguo) times.push(...fuguoSchedule[day].times);
        if (hasRende) times.push(...rendeSchedule[day].times);

        if (times.length > 0) {
          ctx.font = 'bold 24px Arial';
          ctx.fillStyle = textColor;
          ctx.textAlign = 'center';
          const startY = y + 65;
          const lineHeight = 30;
          
          times.forEach((time, i) => {
            if (startY + i * lineHeight < y + cellHeight - 10) {
              ctx.fillText(time, x + cellWidth / 2, startY + i * lineHeight);
            }
          });
        }
      }
    }

    if (notes.trim()) {
      const notesY = calendarTop + headerHeight + rows * cellHeight + 20;
      ctx.fillStyle = customPrimaryColor + '80';
      ctx.fillRect(20, notesY, width - 40, height - notesY - 20);
      
      ctx.fillStyle = textColor;
      ctx.font = '20px Arial';
      ctx.textAlign = 'left';
      
      const noteLines = notes.split('\n');
      noteLines.forEach((line, i) => {
        if (notesY + 30 + i * 25 < height - 10) {
          ctx.fillText(line, 40, notesY + 30 + i * 25);
        }
      });
    }
  };

  useEffect(() => {
    const canvas = canvasRef.current;
    // é™ä½è§£æåº¦ä»¥æ”¹å–„æ‰‹æ©Ÿæ•ˆèƒ½
    canvas.width = 800;
    canvas.height = 1000;
    drawCalendar();
  }, [year, month, fuguoScheduleText, rendeScheduleText, notes, backgroundImage, holidayImage, useEmoji, holidayEmoji, customPrimaryColor, customSecondaryColor, customAccentColor, textColor, holidayDays]);

  const handleBackgroundUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          setBackgroundImage(img);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const handleHolidayImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          setHolidayImage(img);
          setUseEmoji(false);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const [downloadedImage, setDownloadedImage] = useState(null);

  const downloadImage = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    try {
      // ä½¿ç”¨è¼ƒä½çš„åœ–ç‰‡å“è³ªä»¥é¿å…æ‰‹æ©Ÿè¨˜æ†¶é«”å•é¡Œ
      const dataURL = canvas.toDataURL('image/jpeg', 0.9);
      setDownloadedImage(dataURL);
    } catch (error) {
      console.error('ç”Ÿæˆåœ–ç‰‡å¤±æ•—:', error);
      alert('ç”Ÿæˆåœ–ç‰‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  const daysInMonth = getDaysInMonth(year, month);
  const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-6">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">æœˆæ›†æ’ç¨‹è£½åœ–å·¥å…·</h1>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="space-y-4">
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">æœˆä»½è¨­å®š</h3>
              <div className="flex gap-2">
                <input
                  type="number"
                  value={year}
                  onChange={(e) => setYear(parseInt(e.target.value))}
                  className="flex-1 p-2 border rounded"
                  placeholder="å¹´ä»½"
                />
                <input
                  type="number"
                  value={month}
                  min="1"
                  max="12"
                  onChange={(e) => setMonth(parseInt(e.target.value))}
                  className="w-20 p-2 border rounded"
                  placeholder="æœˆ"
                />
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">å¾©åœ‹åº—æ’ç¨‹è³‡æ–™</h3>
              <p className="text-sm text-gray-600 mb-2">
                æ ¼å¼:æ—¥æœŸ + æ˜ŸæœŸ<br/>
                ä¸‹ä¸€è¡Œ:æ™‚é–“ (ç”¨é€—è™Ÿåˆ†éš”)
              </p>
              <textarea
                value={fuguoScheduleText}
                onChange={(e) => setFuguoScheduleText(e.target.value)}
                className="w-full h-48 p-3 border rounded font-mono text-sm"
                placeholder="12æœˆ12æ—¥ é€±äº”&#10;14:00, 16:00&#10;12æœˆ13æ—¥ é€±å…­&#10;16:00"
              />
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">ä»å¾·åº—æ’ç¨‹è³‡æ–™</h3>
              <p className="text-sm text-gray-600 mb-2">
                æ ¼å¼:æ—¥æœŸ + æ˜ŸæœŸ<br/>
                ä¸‹ä¸€è¡Œ:æ™‚é–“ (ç”¨é€—è™Ÿåˆ†éš”)
              </p>
              <textarea
                value={rendeScheduleText}
                onChange={(e) => setRendeScheduleText(e.target.value)}
                className="w-full h-48 p-3 border rounded font-mono text-sm"
                placeholder="12æœˆ22æ—¥ é€±ä¸€&#10;10:00, 16:00, 18:00&#10;12æœˆ23æ—¥ é€±äºŒ&#10;10:00, 12:00, 14:00, 16:00"
              />
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">ä¼‘å‡æ—¥æœŸ</h3>
              <div className="grid grid-cols-7 gap-2">
                {daysArray.map(day => (
                  <button
                    key={day}
                    onClick={() => toggleDay(day)}
                    className={`h-10 rounded text-sm font-medium transition ${
                      holidayDays.includes(day)
                        ? 'bg-red-500 text-white'
                        : 'bg-gray-100 hover:bg-gray-200'
                    }`}
                  >
                    {day}
                  </button>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3 flex items-center gap-2">
                <Palette size={20} />
                é…è‰²è¨­å®š
              </h3>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">ä¸»è¦é¡è‰² (æ¨™é¡Œã€é‚Šæ¡†)</label>
                  <div className="grid grid-cols-8 gap-2">
                    {softColors.map((c) => (
                      <button
                        key={c.name}
                        onClick={() => setCustomPrimaryColor(c.color)}
                        className={`h-10 rounded border-2 transition ${
                          customPrimaryColor === c.color ? 'border-blue-500 scale-110' : 'border-gray-300'
                        }`}
                        style={{ backgroundColor: c.color }}
                        title={c.name}
                      />
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">æ¬¡è¦é¡è‰² (æ ¼å­ç·š)</label>
                  <div className="grid grid-cols-8 gap-2">
                    {softColors.map((c) => (
                      <button
                        key={c.name}
                        onClick={() => setCustomSecondaryColor(c.color)}
                        className={`h-10 rounded border-2 transition ${
                          customSecondaryColor === c.color ? 'border-blue-500 scale-110' : 'border-gray-300'
                        }`}
                        style={{ backgroundColor: c.color }}
                        title={c.name}
                      />
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">èƒŒæ™¯é¡è‰²</label>
                  <div className="grid grid-cols-8 gap-2">
                    {softColors.map((c) => (
                      <button
                        key={c.name}
                        onClick={() => setCustomAccentColor(c.color)}
                        className={`h-10 rounded border-2 transition ${
                          customAccentColor === c.color ? 'border-blue-500 scale-110' : 'border-gray-300'
                        }`}
                        style={{ backgroundColor: c.color }}
                        title={c.name}
                      />
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">æ–‡å­—é¡è‰²</label>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setTextColor('#000000')}
                      className={`flex-1 h-10 rounded border-2 transition ${
                        textColor === '#000000' ? 'border-blue-500 scale-105' : 'border-gray-300'
                      }`}
                      style={{ backgroundColor: '#000000', color: '#FFFFFF' }}
                    >
                      é»‘è‰²
                    </button>
                    <button
                      onClick={() => setTextColor('#FFFFFF')}
                      className={`flex-1 h-10 rounded border-2 transition ${
                        textColor === '#FFFFFF' ? 'border-blue-500 scale-105' : 'border-gray-300'
                      }`}
                      style={{ backgroundColor: '#FFFFFF', color: '#000000' }}
                    >
                      ç™½è‰²
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3 flex items-center gap-2">
                <Upload size={20} />
                èƒŒæ™¯åœ–ç‰‡
              </h3>
              <input
                type="file"
                ref={fileInputRef}
                onChange={handleBackgroundUpload}
                accept="image/*"
                className="hidden"
              />
              <button
                onClick={() => fileInputRef.current.click()}
                className="w-full p-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              >
                ä¸Šå‚³èƒŒæ™¯åœ–
              </button>
              {backgroundImage && (
                <button
                  onClick={() => setBackgroundImage(null)}
                  className="w-full mt-2 p-2 bg-gray-300 rounded hover:bg-gray-400"
                >
                  ç§»é™¤èƒŒæ™¯
                </button>
              )}
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">ä¼‘å‡æ¨™è¨˜æ¨£å¼</h3>
              <div className="space-y-3">
                <label className="flex items-center gap-2">
                  <input
                    type="radio"
                    checked={useEmoji}
                    onChange={() => setUseEmoji(true)}
                  />
                  ä½¿ç”¨ Emoji
                </label>
                {useEmoji && (
                  <input
                    type="text"
                    value={holidayEmoji}
                    onChange={(e) => setHolidayEmoji(e.target.value)}
                    className="w-full p-2 border rounded text-center text-2xl"
                    placeholder="è¼¸å…¥ Emoji"
                  />
                )}
                <label className="flex items-center gap-2">
                  <input
                    type="radio"
                    checked={!useEmoji}
                    onChange={() => setUseEmoji(false)}
                  />
                  ä½¿ç”¨åœ–ç‰‡
                </label>
                {!useEmoji && (
                  <>
                    <input
                      type="file"
                      ref={holidayImageRef}
                      onChange={handleHolidayImageUpload}
                      accept="image/*"
                      className="hidden"
                    />
                    <button
                      onClick={() => holidayImageRef.current.click()}
                      className="w-full p-2 bg-green-500 text-white rounded hover:bg-green-600"
                    >
                      ä¸Šå‚³ä¼‘å‡åœ–ç‰‡
                    </button>
                  </>
                )}
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">å‚™è¨»</h3>
              <textarea
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                className="w-full h-32 p-3 border rounded"
                placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»..."
              />
            </div>

            <button
              onClick={downloadImage}
              className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 flex items-center justify-center gap-2"
            >
              <Download size={20} />
              ç”Ÿæˆåœ–ç‰‡
            </button>

            {downloadedImage && (
              <div className="bg-white rounded-lg shadow p-4">
                <h3 className="font-semibold text-lg mb-3 text-center text-green-600">âœ“ åœ–ç‰‡å·²ç”Ÿæˆ</h3>
                <p className="text-sm text-gray-600 mb-3 text-center font-bold">
                  ğŸ“± é•·æŒ‰ä¸‹æ–¹åœ–ç‰‡ â†’ é¸æ“‡ã€ŒåŠ å…¥ç…§ç‰‡ã€æˆ–ã€Œå„²å­˜åœ–ç‰‡ã€
                </p>
                <img 
                  src={downloadedImage} 
                  alt="æœˆæ›†åœ–ç‰‡" 
                  className="w-full border-2 border-green-500 rounded"
                  style={{ maxWidth: '100%', height: 'auto' }}
                />
                <p className="text-xs text-gray-500 mt-2 text-center">
                  æç¤ºï¼šé•·æŒ‰åœ–ç‰‡ç´„2ç§’æœƒå‡ºç¾é¸å–®
                </p>
              </div>
            )}
          </div>

          <div className="lg:col-span-2">
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-semibold text-lg mb-3">é è¦½</h3>
              <div className="overflow-auto">
                <canvas
                  ref={canvasRef}
                  className="border border-gray-300 rounded max-w-full"
                  style={{ width: '100%', height: 'auto' }}
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
